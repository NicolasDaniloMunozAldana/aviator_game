global
    daemon
    maxconn 4096
    log stdout format raw local0

defaults
    mode tcp
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout check 5s
    log global

# Frontend para escritura (maestro)
frontend postgres_write
    bind *:5432
    default_backend postgres_master

# Frontend para lectura (réplicas)  
frontend postgres_read
    bind *:5433
    default_backend postgres_replicas

# Backend para el maestro (escritura)
backend postgres_master
    balance first
    option httpchk GET /master
    http-check expect status 200
    server postgres1 postgres1:5432 check port 8008 inter 5s rise 2 fall 3
    server postgres2 postgres2:5432 check port 8008 inter 5s rise 2 fall 3 backup
    server postgres3 postgres3:5432 check port 8008 inter 5s rise 2 fall 3 backup

# Backend para réplicas (lectura)
backend postgres_replicas
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    server postgres1 postgres1:5432 check port 8008 inter 5s rise 2 fall 3
    server postgres2 postgres2:5432 check port 8008 inter 5s rise 2 fall 3
    server postgres3 postgres3:5432 check port 8008 inter 5s rise 2 fall 3

# Estadísticas de HAProxy
frontend stats
    bind *:8080
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
